#!/bin/bash
set -e
set -o pipefail

pushd $(dirname $0) > /dev/null
BIN_DIR=$(pwd)
popd > /dev/null

source $BIN_DIR/../bin-pkg/config

BUILD_DIR=$1
CACHE_DIR=$2
BASE_DIR=$BUILD_DIR/heroku
NGINX_URL="http://${S3_BUCKET}.s3.amazonaws.com/nginx-${NGINX_VERSION}.tar.gz"
PHP_URL="http://${S3_BUCKET}.s3.amazonaws.com/php-${PHP_VERSION}.tar.gz"

mkdir -p $BASE_DIR

# PHP ...
cd $BASE_DIR
if [ ! -d ./vendor/php ]; then
    echo "-----> Installing php v${PHP_VERSION}"
    mkdir -p ./vendor/php
    cd ./vendor/php
    curl -s --max-time 160 --location $PHP_URL | tar xz
fi

# NGINX ...
cd $BASE_DIR
if [ ! -d ./vendor/nginx ]; then
    echo "-----> Installing nginx v${NGINX_VERSION}"
    mkdir -p ./vendor/nginx
    cd ./vendor/nginx
    curl -s --max-time 60 --location $NGINX_URL | tar xz
fi

# Assets ...
cd $BASE_DIR
echo "-----> Copying configuration"
rm -rf ./etc
cp -r $BIN_DIR/../etc etc

echo "-----> Generating boot script"

cat > $BASE_DIR/run <<EOF
#!/usr/bin/env bash
echo "Generating nginx.conf"
erb ${ROOT}/etc/nginx.conf.erb > ${ROOT}/vendor/nginx/conf/nginx.conf

echo "Starting php-fpm"
${ROOT}/vendor/php/sbin/php-fpm -y ${ROOT}/etc/php-fpm.conf -c ${ROOT}/etc/php.ini

echo "Starting nginx"
mkdir -p /tmp/client_body /tmp/fastcgi
touch ${ROOT}/vendor/nginx/logs/http.log
tail -f -n 0 ${ROOT}/vendor/nginx/logs/http.log &
${ROOT}/vendor/nginx/sbin/nginx -c ${ROOT}/vendor/nginx/conf/nginx.conf
EOF

chmod +x $BASE_DIR/run
